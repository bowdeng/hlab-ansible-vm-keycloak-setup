---
# roles/keycloak/tasks/main.yml

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install required packages
  apt:
    name:
      - openjdk-17-jdk
      - unzip
      - python3-psycopg2
      - openssl
    state: present
  become: yes

# Database setup
- name: Create Keycloak database
  postgresql_db:
    name: "{{ keycloak_db_name }}"
    encoding: UTF-8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Create Keycloak database user
  postgresql_user:
    name: "{{ keycloak_db_user }}"
    password: "{{ keycloak_db_password }}"
    db: "{{ keycloak_db_name }}"
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Grant all privileges on database to Keycloak user
  postgresql_privs:
    database: "{{ keycloak_db_name }}"
    privs: ALL
    type: database
    role: "{{ keycloak_db_user }}"
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

- name: Grant schema permissions to Keycloak user
  postgresql_privs:
    database: "{{ keycloak_db_name }}"
    objs: public
    privs: CREATE,USAGE
    type: schema
    role: "{{ keycloak_db_user }}"
  become: yes
  become_user: postgres
  vars:
    ansible_ssh_pipelining: true

# Keycloak user and directory setup
- name: Create Keycloak group
  group:
    name: "{{ keycloak_group }}"
    state: present
  become: yes

- name: Create Keycloak user
  user:
    name: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    home: "{{ keycloak_install_dir }}"
    shell: /bin/bash
    system: yes
    createhome: no
  become: yes

- name: Create Keycloak installation directory
  file:
    path: "{{ keycloak_install_dir }}"
    state: directory
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0755"
  become: yes

# Download and install Keycloak
- name: Check if Keycloak is already installed
  stat:
    path: "{{ keycloak_home }}"
  register: keycloak_installed

- name: Download Keycloak
  get_url:
    url: "{{ keycloak_download_url }}"
    dest: "/tmp/{{ keycloak_archive }}"
    mode: "0644"
  when: not keycloak_installed.stat.exists
  become: yes

- name: Extract Keycloak archive
  unarchive:
    src: "/tmp/{{ keycloak_archive }}"
    dest: "{{ keycloak_install_dir }}"
    remote_src: yes
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
  when: not keycloak_installed.stat.exists
  become: yes

- name: Remove Keycloak archive
  file:
    path: "/tmp/{{ keycloak_archive }}"
    state: absent
  when: not keycloak_installed.stat.exists
  become: yes

# SSL/TLS certificate setup
- name: Create Keycloak conf directory
  file:
    path: "{{ keycloak_home }}/conf"
    state: directory
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0755"
  become: yes

- name: Copy SSL certificate
  copy:
    src: "certs/{{ keycloak_cert_file }}"
    dest: "{{ keycloak_home }}/conf/{{ keycloak_cert_file }}"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0644"
  become: yes
  notify: restart keycloak

- name: Copy SSL private key
  copy:
    src: "certs/{{ keycloak_key_file }}"
    dest: "{{ keycloak_home }}/conf/{{ keycloak_key_file }}"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0600"
  become: yes
  notify: restart keycloak

- name: Copy CA bundle
  copy:
    src: "certs/{{ keycloak_ca_bundle_file }}"
    dest: "{{ keycloak_home }}/conf/{{ keycloak_ca_bundle_file }}"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0644"
  become: yes
  notify: restart keycloak

- name: Create combined certificate chain
  shell: |
    cat {{ keycloak_home }}/conf/{{ keycloak_cert_file }} \
        {{ keycloak_home }}/conf/{{ keycloak_ca_bundle_file }} \
        > {{ keycloak_home }}/conf/fullchain.crt
  args:
    creates: "{{ keycloak_home }}/conf/fullchain.crt"
  become: yes
  become_user: "{{ keycloak_user }}"

- name: Check if private key is encrypted
  shell: |
    grep -q "ENCRYPTED" {{ keycloak_home }}/conf/{{ keycloak_key_file }} && echo "encrypted" || echo "unencrypted"
  register: key_encryption_status
  changed_when: false
  become: yes

- name: Debug - Check original key file content
  shell: |
    head -n 5 {{ keycloak_home }}/conf/{{ keycloak_key_file }}
  register: key_header
  changed_when: false
  become: yes

- name: Debug - Display key header
  debug:
    msg: "Key file first 5 lines: {{ key_header.stdout_lines }}"

- name: Debug - Check if file contains certificate instead of key
  shell: |
    if grep -q "BEGIN CERTIFICATE" {{ keycloak_home }}/conf/{{ keycloak_key_file }}; then
      echo "certificate"
    elif grep -q "BEGIN.*PRIVATE KEY" {{ keycloak_home }}/conf/{{ keycloak_key_file }}; then
      echo "private_key"
    else
      echo "unknown"
    fi
  register: file_type_check
  changed_when: false
  become: yes

- name: Debug - Display file type
  debug:
    msg: "File contains: {{ file_type_check.stdout }}"

- name: Fail if key file is actually a certificate
  fail:
    msg: "The file {{ keycloak_key_file }} appears to be a certificate, not a private key. Please provide the actual private key file."
  when: file_type_check.stdout == "certificate"

- name: Remove existing decrypted key if present
  file:
    path: "{{ keycloak_home }}/conf/decrypted_key.pem"
    state: absent
  become: yes
  when: key_header.stdout is defined

- name: Convert private key to RSA format
  shell: |
    if openssl rsa -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -check -noout 2>/dev/null; then
      # Key is already valid RSA, just copy it
      cp {{ keycloak_home }}/conf/{{ keycloak_key_file }} {{ keycloak_home }}/conf/decrypted_key.pem
    elif openssl ec -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -check -noout 2>/dev/null; then
      # Key is EC, convert it
      openssl ec -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -out {{ keycloak_home }}/conf/decrypted_key.pem
    elif openssl pkey -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -check -noout 2>/dev/null; then
      # Generic key format, use pkey
      openssl pkey -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -out {{ keycloak_home }}/conf/decrypted_key.pem
    else
      # Try as encrypted RSA with empty password
      openssl rsa -in {{ keycloak_home }}/conf/{{ keycloak_key_file }} -passin pass: -out {{ keycloak_home }}/conf/decrypted_key.pem 2>/dev/null || \
      # Last resort - just copy
      cp {{ keycloak_home }}/conf/{{ keycloak_key_file }} {{ keycloak_home }}/conf/decrypted_key.pem
    fi
  become: yes
  become_user: "{{ keycloak_user }}"

- name: Verify decrypted key is readable
  shell: |
    openssl rsa -in {{ keycloak_home }}/conf/decrypted_key.pem -check -noout 2>&1 || \
    openssl ec -in {{ keycloak_home }}/conf/decrypted_key.pem -check -noout 2>&1 || \
    openssl pkey -in {{ keycloak_home }}/conf/decrypted_key.pem -check -noout 2>&1
  register: key_verify
  changed_when: false
  failed_when: false
  become: yes

- name: Debug - Show key verification result
  debug:
    msg:
      - "Key verification exit code: {{ key_verify.rc }}"
      - "Key verification output: {{ key_verify.stdout }}"

- name: Fail with helpful message if key is not readable
  fail:
    msg: |
      The private key file could not be read or converted properly.
      Original file: {{ keycloak_key_file }}
      File type detected: {{ file_type_check.stdout }}

      This usually means:
      1. The .pem file is actually a certificate, not a private key
      2. The private key is in a different file (often .key extension)
      3. The key file is corrupted or in an unsupported format

      Please verify you have the correct private key file and update the keycloak_key_file variable.
      Common private key files end with: .key, -key.pem, .private.pem
  when: key_verify.rc != 0

- name: Set decrypted key permissions
  file:
    path: "{{ keycloak_home }}/conf/decrypted_key.pem"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0600"
  become: yes

- name: Verify certificate and key match
  shell: |
    CERT_MODULUS=$(openssl x509 -noout -modulus -in {{ keycloak_home }}/conf/{{ keycloak_cert_file }} 2>/dev/null | openssl md5)
    KEY_MODULUS=$(openssl rsa -noout -modulus -in {{ keycloak_home }}/conf/decrypted_key.pem 2>/dev/null | openssl md5 || \
                  openssl ec -noout -text -in {{ keycloak_home }}/conf/decrypted_key.pem 2>/dev/null | grep pub -A 10 | openssl md5)

    echo "Certificate MD5: $CERT_MODULUS"
    echo "Key MD5: $KEY_MODULUS"

    if [ "$CERT_MODULUS" = "$KEY_MODULUS" ]; then
      echo "MATCH: Certificate and key are a matching pair"
      exit 0
    else
      echo "MISMATCH: Certificate and key do NOT match"
      exit 1
    fi
  register: cert_key_match
  failed_when: false
  changed_when: false
  become: yes

- name: Display certificate/key match result
  debug:
    msg: "{{ cert_key_match.stdout_lines }}"

- name: Fail if certificate and key don't match
  fail:
    msg: |
      ERROR: The certificate and private key do not match!

      Certificate file: {{ keycloak_cert_file }}
      Private key file: {{ keycloak_key_file }}

      This means these files are not a matching pair. You need to ensure that:
      1. The certificate was generated from this specific private key
      2. Both files are from the same certificate request/generation process
      3. The files haven't been mixed up with certificates/keys from different domains

      To verify your files locally, run:
      openssl x509 -noout -modulus -in {{ keycloak_cert_file }} | openssl md5
      openssl rsa -noout -modulus -in {{ keycloak_key_file }} | openssl md5

      These two commands should produce identical MD5 hashes.
  when: cert_key_match.rc != 0

- name: Create PKCS12 keystore from certificates
  shell: |
    openssl pkcs12 -export \
      -in {{ keycloak_home }}/conf/fullchain.crt \
      -inkey {{ keycloak_home }}/conf/decrypted_key.pem \
      -out {{ keycloak_keystore_path }} \
      -name keycloak \
      -passout pass:{{ keycloak_keystore_password }}
  args:
    creates: "{{ keycloak_keystore_path }}"
  become: yes
  become_user: "{{ keycloak_user }}"
  notify: restart keycloak

- name: Set keystore permissions
  file:
    path: "{{ keycloak_keystore_path }}"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0600"
  become: yes

# Theme deployment
- name: Create themes directory
  file:
    path: "{{ keycloak_home }}/themes/{{ keycloak_custom_theme_name }}"
    state: directory
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0755"
  become: yes

- name: Copy custom theme
  copy:
    src: "{{ keycloak_custom_theme_name }}/"
    dest: "{{ keycloak_home }}/themes/{{ keycloak_custom_theme_name }}/"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0755"
  become: yes
  notify: restart keycloak

# Keycloak configuration
- name: Create Keycloak configuration file
  template:
    src: keycloak.conf.j2
    dest: "{{ keycloak_home }}/conf/keycloak.conf"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0644"
  become: yes
  notify: restart keycloak

# Systemd service setup
- name: Create Keycloak systemd service file
  template:
    src: keycloak.service.j2
    dest: /etc/systemd/system/keycloak.service
    owner: root
    group: root
    mode: "0644"
  become: yes
  notify: restart keycloak

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

- name: Enable and start Keycloak service
  systemd:
    name: keycloak
    enabled: yes
    state: started
  become: yes

# Wait for Keycloak to be ready
- name: Wait for Keycloak to be ready
  uri:
    url: "https://{{ keycloak_hostname }}:{{ keycloak_https_port }}/health/ready"
    validate_certs: no
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 10
  ignore_errors: yes

# Realm import
- name: Copy realm configuration
  copy:
    src: "../{{ keycloak_realm_file }}"
    dest: "{{ keycloak_home }}/data/import/{{ keycloak_realm_file }}"
    owner: "{{ keycloak_user }}"
    group: "{{ keycloak_group }}"
    mode: "0644"
  become: yes

- name: Check if realm already exists
  uri:
    url: "https://{{ keycloak_hostname }}:{{ keycloak_https_port }}/realms/{{ keycloak_realm_name }}"
    validate_certs: no
    status_code: [200, 404]
  register: realm_check
  ignore_errors: yes

- name: Import realm via Keycloak CLI
  shell: |
    {{ keycloak_home }}/bin/kc.sh import \
      --file {{ keycloak_home }}/data/import/{{ keycloak_realm_file }} \
      --override true
  become: yes
  become_user: "{{ keycloak_user }}"
  when: realm_check.status == 404 or realm_check.failed
  notify: restart keycloak

- name: Display Keycloak access information
  debug:
    msg:
      - "Keycloak is now running!"
      - "Access URL: https://{{ keycloak_hostname }}:{{ keycloak_https_port }}"
      - "Admin Console: https://{{ keycloak_hostname }}:{{ keycloak_https_port }}/admin"
      - "Admin Username: {{ keycloak_admin_user }}"
      - "Realm: {{ keycloak_realm_name }}"
